# --- General Settings ---
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB" # Enable true color support
set -g status-position bottom                    # Status bar at the bottom
set -g display-panes-time 3000
set -g history-limit 100000
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-window on
set -wg automatic-rename on
set-option -s focus-events on
set-option -s extended-keys on
setw -g mode-keys vi
set -g set-clipboard on

# Enable basic mouse support (scrolling and resizing)
set -g mouse on

# Disable the context menu (Right-Click)
unbind -n MouseDown3Pane
# Disable selection/copy-mode on drag (Left-Click + Drag)
#    (This leaves resizing borders enabled, as that uses MouseDrag1Border)
unbind -n MouseDrag1Pane
# Disable middle click paste
unbind -n MouseDown2Pane

set -g detach-on-destroy off
set -g set-titles on
set -g set-titles-string "#S: #W"
set -g allow-passthrough on

# --- Theme & Appearance ---

# --- Catppuccin Mocha Color Palette ---
thm_bg="#1e1e2e"
thm_fg="#cdd6f4"
thm_cyan="#89dceb"
thm_black="#181825"
thm_gray="#313244"
thm_magenta="#cba6f7"
thm_pink="#f5c2e7"
thm_red="#f38ba8"
thm_green="#a6e3a1"
thm_yellow="#f9e2af"
thm_blue="#89b4fa"
thm_orange="#fab387"
thm_black4="#585b70"
thm_mauve="#8839ef"

thm_myblue_dark="#2d3f76"
thm_myblue="#6699cc"
thm_green_dark="#5e815e"
thm_blue_dark="#56687e"


# Status Bar
set -g status-style "bg=${thm_bg},fg=${thm_fg}"
set -g status-left-length 100
set -g status-right-length 100

# Pane borders
set -g pane-border-indicators arrows
set -g pane-border-lines heavy
set -g pane-border-style "fg=${thm_gray}"
set -g pane-active-border-style "fg=${thm_blue}"

# Popup styling
set -g popup-style "bg=${thm_bg},fg=${thm_fg}"
set -g popup-border-style "fg=${thm_yellow}, bg=${thm_bg}"
set -g popup-border-lines rounded

# Message/Command prompt
set -g message-style "fg=${thm_cyan},bg=${thm_gray}"
set -g message-command-style "fg=${thm_cyan},bg=${thm_gray}"

# Clock Mode
setw -g clock-mode-colour "${thm_blue}"

# Pane Numbers shown on Prefix + q
set -g display-panes-active-colour "${thm_orange}"
set -g display-panes-colour "${thm_blue}"

# Selection mode
setw -g mode-style "fg=${thm_bg},bg=${thm_magenta},bold"

# Menu Styling (Available in newer tmux versions)
set -g menu-style "fg=${thm_myblue},bg=${thm_bg}"
set -g menu-selected-style "fg=${thm_myblue},bg=${thm_myblue_dark}"
set -g menu-border-style "fg=${thm_myblue},bg=${thm_bg}"
set -g menu-border-lines rounded

# Icons
icon_sync="󰌹"
icon_prefix=""
icon_ssh=""
icon_scratch=""
icon_normal=""

icon_zoom="󰊓"
icon_bell="!"
icon_activity="≈"
icon_last="•"
icon_separator="━"

# Window Status
setw -g monitor-activity on
setw -g monitor-bell on

# Unfocused window
# Bell Icon > Activity Icon > Last Window Bullet > Space
window_status_icon="#{?window_bell_flag,#[fg=${thm_red}]${icon_bell},\
#{?window_activity_flag,#[fg=${thm_magenta}]${icon_activity},\
#{?window_last_flag,${icon_last}, \
}}}"
setw -g window-status-format "#[fg=${thm_orange},bg=${thm_bg}]${window_status_icon}#I:#W "

# Focused (current) window
# If zoomed show Zoom Icon, otherwise show Index Number
window_current_prefix="#{?window_zoomed_flag,${icon_zoom} ,#I:}"
setw -g window-status-current-format "#[fg=${thm_bg},bg=${thm_orange}]░${window_current_prefix}#W "

setw -g window-status-separator ""
setw -g window-status-style "fg=${thm_fg},bg=${thm_bg}"

# Status Left/Right Content
# Logic for the session (Priority: Sync > Prefix > Scratch > SSH > Normal)
session_mode_color="#{?pane_synchronized,${thm_red},\
#{?client_prefix,${thm_mauve},\
#{?#{==:#S,scratch},${thm_yellow},\
#{?SSH_CONNECTION,${thm_blue},${thm_green}}\
}}}"

session_mode_icon="#{?pane_synchronized,${icon_sync},\
#{?client_prefix,${icon_prefix},\
#{?#{==:#S,scratch},${icon_scratch},\
#{?SSH_CONNECTION,${icon_ssh},${icon_normal}}\
}}}"

# Left: Session name
set -g status-left "#[bg=${session_mode_color},fg=${thm_bg}] ${session_mode_icon} #S #[fg=default,bg=default]#[fg=${session_mode_color}]${icon_separator}"

# Right: IP and host
set -g status-right "#[fg=${thm_blue},bg=${thm_bg},bold] #(hostname -I | cut -d' ' -f1) "
set -ga status-right "#[fg=${thm_bg},bg=${thm_blue}] #H "

# --- Keybindings ---
# Use C-a as prefix
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Prefix + r - Reload Tmux Configuration
# See: tmux-reload.sh
bind-key -N "Reload Tmux Configuration" r run-shell -b "~/.config/tmux/scripts/dv/dv-reload.sh"

bind-key -N "View Keybindings" ? run-shell -b "~/.config/tmux/scripts/dv/dv-keys.sh"

bind -N "Show Cheatsheet" / run-shell -b "~/.config/tmux/scripts/dv/dv-cheatsheet.sh"

# Window/Pane Creation
unbind %
unbind '"'
bind -N "New Window" c new-window -c "#{pane_current_path}"
bind -N "Split Window H - Side by Side" -r = split-window -h -c "#{pane_current_path}"
bind -N "Split Window V - Stacked" -r - split-window -v -c "#{pane_current_path}"

# Promote Window (Push from Popup -> Window)
bind -n M-w if-shell -F "#{!=:#{q:@popup_parent},}" "run-shell 'tmux move-window -t #{q:@popup_parent}:; ~/.config/tmux/scripts/dv/dv-input.sh --target #{q:@popup_parent}: --type success --message \"Window promoted to #{q:@popup_parent}\"'" "send-keys M-w"

# Hide Popup (Detach)
bind -n M-h if-shell -F "#{!=:#{q:@popup_parent},}" "detach-client" "send-keys M-h"

# Window/Pane Movement
bind -N "Break Pane to New Window" b break-pane
bind -N "Join Pane Screen" j run-shell -b "~/.config/tmux/scripts/dv/dv-join.sh"
bind -N "Send Pane Screen" k if-shell -F "#{!=:#{q:@popup_parent},}" "run-shell 'tmux move-window -t #{q:@popup_parent}:; ~/.config/tmux/scripts/dv/dv-input.sh --target #{q:@popup_parent}: --type success --message \"Window promoted to #{q:@popup_parent}\"'" "run-shell -b \"~/.config/tmux/scripts/dv/dv-send.sh\""
bind -N "Session Manager" s run-shell -b "~/.config/tmux/scripts/dv/dv-session.sh"
bind -N "Choose Tree (Default)" S choose-tree -s
bind -N "Swap Window Left" -r S-Left swap-window -t -1 \; previous-window
bind -N "Swap Window Right" -r S-Right swap-window -t +1 \; next-window

# Sync Panes
bind -N "Toggle Sync Input to Panes" C-s setw synchronize-panes

# Pane Layout
bind -N "Layout Even H - Side by Side" M-h select-layout even-horizontal
bind -N "Layout Even V - Stacked" M-v select-layout even-vertical
bind -N "Layout Tiled" M-t select-layout tiled

# Scratchpad Popup
bind -N "Toggle Scratchpad" ` run-shell -b "~/.config/tmux/scripts/dv/dv-scratch.sh"

# Git Menu (Prefix + g)
bind -N "Git Menu" g display-menu -T "#[align=left,fg=${thm_bg},bg=${thm_blue}]  Git Tools " -x C -y C \
    "Git Branches   #[fg=${thm_blue_dark}](dv-git-branch.sh)"   b "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_blue}\" \"${thm_bg}\"  \"Git Branches\" git-branch \"TMUX_POPUP=1 dv-git-branch.sh\"'" \
    "Git Log           #[fg=${thm_blue_dark}](dv-git-log.sh)"   l "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_blue}\" \"${thm_bg}\"  \"Git Log\" git-log \"TMUX_POPUP=1 dv-git-log.sh\"'" \
    "Git Diff         #[fg=${thm_blue_dark}](dv-git-diff.sh)"   d "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_blue}\" \"${thm_bg}\"  \"Git Diff\" git-diff \"TMUX_POPUP=1 dv-git-diff.sh\"'" \
    "Git Status     #[fg=${thm_blue_dark}](dv-git-status.sh)"   s "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_blue}\" \"${thm_bg}\"  \"Git Status\" git-status \"TMUX_POPUP=1 dv-git-status.sh\"'" \
    "Git Stash       #[fg=${thm_blue_dark}](dv-git-stash.sh)"   t "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_blue}\" \"${thm_bg}\"  \"Git Stash\" git-stash \"TMUX_POPUP=1 dv-git-stash.sh\"'" \
    "File History  #[fg=${thm_blue_dark}](dv-git-history.sh)"   h "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_blue}\" \"${thm_bg}\"  \"File History\" git-history \"TMUX_POPUP=1 dv-git-history.sh\"'" \
    "" \
    "Lazygit                 #[fg=${thm_blue_dark}](lazygit)"   g "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_blue}\" \"${thm_bg}\"  \"Lazygit\" lazygit \"lazygit\"'" \
    "" \
    "Close"               q ""

# Execute Menu (Prefix + e)
bind -N "Execute Menu" e display-menu -T "#[align=left,fg=${thm_bg},bg=${thm_green}] 󰍜 Execute " \
    -S "fg=${thm_green},bg=${thm_bg}" -s "fg=${thm_green},bg=${thm_bg}" -H "fg=${thm_green},bg=${thm_myblue_dark}" \
    -x C -y C \
    "Find File            #[fg=${thm_green_dark}](dv-find.sh)  " f "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_green}\" \"${thm_bg}\" 󰍜 \"Find File\" find dv-find.sh'" \
    "Find in Files         #[fg=${thm_green_dark}](dv-fif.sh)  " g "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_green}\" \"${thm_bg}\" 󰍜 \"Find in Files\" fif dv-fif.sh'" \
    "Process Killer       #[fg=${thm_green_dark}](dv-kill.sh)  " k "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_green}\" \"${thm_bg}\" 󰍜 \"Process Killer\" kill dv-kill.sh'" \
    "Ports               #[fg=${thm_green_dark}](dv-ports.sh)  " p "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_green}\" \"${thm_bg}\" 󰍜 \"Ports\" ports \"dv-ports.sh | less -R\"'" \
    "IP Viewer              #[fg=${thm_green_dark}](dv-ip.sh)  " i "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_green}\" \"${thm_bg}\" 󰍜 \"IP Viewer\" ip \"dv-ip.sh | less -R\"'" \
    "Path Checker         #[fg=${thm_green_dark}](dv-path.sh)  " h "send-keys 'dv-path.sh | less -R' C-m" \
    "Man Pages             #[fg=${thm_green_dark}](dv-man.sh)  " m "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_green}\" \"${thm_bg}\" 󰍜 \"Man Pages\" man dv-man.sh'" \
    "LazyDocker           #[fg=${thm_green_dark}](lazydocker)  " d "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_green}\" \"${thm_bg}\" 󰍜 \"LazyDocker\" lazydocker lazydocker'" \
    "Env Manager           #[fg=${thm_green_dark}](dv-env.sh)  " e "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_green}\" \"${thm_bg}\" 󰍜 \"Env Manager\" env dv-env.sh'" \
    "SSH Manager   #[fg=${thm_green_dark}](dv-ssh-manager.sh)  " s "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_green}\" \"${thm_bg}\" 󰍜 \"SSH Manager\" ssh dv-ssh-manager.sh'" \
    "System Update      #[fg=${thm_green_dark}](dv-update.sh)  " u "run-shell -b '~/.config/tmux/scripts/dv/dv-tm-popup.sh \"${thm_green}\" \"${thm_bg}\" 󰍜 \"System Update\" update \"dv-update.sh; echo Press Enter to close...; read\"'" \
    "" \
    "Close" q ""

# Pane Resizing (vim-style)
bind -N "Resize Left" -r H resize-pane -L 1
bind -N "Resize Down" -r J resize-pane -D 1
bind -N "Resize Up" -r K resize-pane -U 1
bind -N "Resize Right" -r L resize-pane -R 1

# Smart Pane Switching (Vim-aware)
# # Check if current pane is running Vim, fzf, or ssh
# set -g @is_vim "ps -o state= -o comm= -t '#{pane_tty}' | awk '/\\+/ {print \\$2}' | grep -iqE '^(.*/)?(g?view|l?n?vim?x?|fzf|ssh)(diff)?$'"

# # Change active pane border color when in Vim
# set-hook -g pane-focus-in "if-shell '#{@is_vim}' 'set -w pane-active-border-style fg=#a6e3a1' 'set -w pane-active-border-style fg=#89b4fa'"

# # Smart pane switching with awareness of vim splits and pane edges
# bind -n -N "Smart Switch Left" C-h if-shell "#{@is_vim}" "send-keys C-h" "if-shell -F '#{pane_at_edge_left}' '' 'select-pane -L'"
# bind -n -N "Smart Switch Down" C-j if-shell "#{@is_vim}" "send-keys C-j" "if-shell -F '#{pane_at_edge_bottom}' '' 'select-pane -D'"
# bind -n -N "Smart Switch Up" C-k if-shell "#{@is_vim}" "send-keys C-k" "if-shell -F '#{pane_at_edge_top}' '' 'select-pane -U'"
# bind -n -N "Smart Switch Right" C-l if-shell "#{@is_vim}" "send-keys C-l" "if-shell -F '#{pane_at_edge_right}' 'send-keys C-l' 'select-pane -R'"

# 1. Define the 'is_vim' check (includes fzf and ssh)
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf|ssh)(diff)?$'"

# 2. Use run-shell inside the hook for live evaluation
# set-hook -g pane-focus-in "run-shell \"if $is_vim; then \
#     tmux set -w pane-active-border-style 'fg=#a6e3a1'; \
#     else \
#     tmux set -w pane-active-border-style 'fg=#89b4fa'; \
#     fi\""

# 2b. Ensure focus events are enabled (crucial for hooks to trigger)
# set -g focus-events on

# 3. Smart pane switching logic
bind-key -n -N "Smart Switch Left" 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n -N "Smart Switch Down" 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n -N "Smart Switch Up" 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n -N "Smart Switch Right" 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

bind -N "Clear Screen (fallback)" C-l send-keys 'C-l'

# Window Navigation
bind -N "Previous Window" C-p previous-window
bind -N "Next Window" C-n next-window

# Copy Mode (vim-style)
bind -N "Enter Copy Mode" v copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# --- Plugins & Configuration ---
# Use XDG-compliant path for plugins
set-environment -g TMUX_PLUGIN_MANAGER_PATH "~/.config/tmux/plugins"

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'sainnhe/tmux-fzf'

# Tmux FZF Options
set-environment -g TMUX_FZF_LAUNCH_KEY "C-f"
set-environment -g TMUX_FZF_OPTIONS "-p -w 80% -h 70% -m \
  --layout=reverse \
  --color=bg+:#2d3f76 \
  --color=bg:#1e2030 \
  --color=border:#589ed7 \
  --color=fg:#c8d3f5 \
  --color=gutter:#1e2030 \
  --color=header:#ff966c \
  --color=hl+:#65bcff \
  --color=hl:#65bcff \
  --color=info:#545c7e \
  --color=label:#545c7e \
  --color=marker:#ff007c \
  --color=pointer:#ff007c \
  --color=prompt:#65bcff \
  --color=query:#c8d3f5:regular \
  --color=scrollbar:#589ed7 \
  --color=separator:#ff966c \
  --color=spinner:#ff007c \
"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
