# --- General Settings ---
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB" # Enable true color support
set -g status-position bottom                    # Status bar at the bottom
set -g display-panes-time 3000
set -g history-limit 100000
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-window on
set -wg automatic-rename on
set-option -s focus-events on
set-option -s extended-keys on
setw -g mode-keys vi
set -g set-clipboard on

# --- Theme & Appearance ---

# --- Catppuccin Mocha Color Palette ---
thm_bg="#1e1e2e"
thm_fg="#cdd6f4"
thm_cyan="#89dceb"
thm_black="#181825"
thm_gray="#313244"
thm_magenta="#cba6f7"
thm_pink="#f5c2e7"
thm_red="#f38ba8"
thm_green="#a6e3a1"
thm_yellow="#f9e2af"
thm_blue="#89b4fa"
thm_orange="#fab387"
thm_black4="#585b70"
thm_mauve="#8839ef"

# Status Bar
set -g status-style "bg=${thm_bg},fg=${thm_fg}"
set -g status-left-length 100
set -g status-right-length 100

# Pane borders
set -g pane-border-indicators arrows
set -g pane-border-lines heavy
set -g pane-border-style "fg=${thm_gray}"
set -g pane-active-border-style "fg=${thm_blue}"

# Popup styling
set -g popup-style "bg=${thm_bg},fg=${thm_fg}"
set -g popup-border-style "fg=${thm_yellow}, bg=${thm_bg}"
set -g popup-border-lines rounded

# Message/Command prompt
set -g message-style "fg=${thm_cyan},bg=${thm_gray}"
set -g message-command-style "fg=${thm_cyan},bg=${thm_gray}"

# Clock Mode
setw -g clock-mode-colour "${thm_blue}"

# Pane Numbers shown on Prefix + q
set -g display-panes-active-colour "${thm_orange}"
set -g display-panes-colour "${thm_blue}"

# Selection mode
setw -g mode-style "fg=${thm_bg},bg=${thm_magenta},bold"

# Menu Styling (Available in newer tmux versions)
set -g menu-style "fg=${thm_fg},bg=${thm_bg}"
set -g menu-selected-style "fg=${thm_bg},bg=${thm_magenta}"

# Icons
icon_sync="󰌹"
icon_prefix=""
icon_ssh=""
icon_scratch=""
icon_normal=""

icon_zoom="󰊓"
icon_bell="!"
icon_activity="≈"
icon_last="•"
icon_separator="━"

# Window Status
setw -g monitor-activity on
setw -g monitor-bell on

# Unfocused window
# Bell Icon > Activity Icon > Last Window Bullet > Space
window_status_icon="#{?window_bell_flag,#[fg=${thm_red}]${icon_bell},\
#{?window_activity_flag,#[fg=${thm_magenta}]${icon_activity},\
#{?window_last_flag,${icon_last}, \
}}}"
setw -g window-status-format "#[fg=${thm_orange},bg=${thm_bg}]${window_status_icon}#I:#W "

# Focused (current) window
# If zoomed show Zoom Icon, otherwise show Index Number
window_current_prefix="#{?window_zoomed_flag,${icon_zoom} ,#I:}"
setw -g window-status-current-format "#[fg=${thm_bg},bg=${thm_orange}]░${window_current_prefix}#W "

setw -g window-status-separator ""
setw -g window-status-style "fg=${thm_fg},bg=${thm_bg}"

# Status Left/Right Content
# Logic for the session (Priority: Sync > Prefix > Scratch > SSH > Normal)
session_mode_color="#{?pane_synchronized,${thm_red},\
#{?client_prefix,${thm_mauve},\
#{?#{==:#S,scratch},${thm_yellow},\
#{?SSH_CONNECTION,${thm_blue},${thm_green}}\
}}}"

session_mode_icon="#{?pane_synchronized,${icon_sync},\
#{?client_prefix,${icon_prefix},\
#{?#{==:#S,scratch},${icon_scratch},\
#{?SSH_CONNECTION,${icon_ssh},${icon_normal}}\
}}}"

# Left: Session name
set -g status-left "#[bg=${session_mode_color},fg=${thm_bg}] ${session_mode_icon} #S #[fg=default,bg=default]#[fg=${session_mode_color}]${icon_separator}"

# Right: IP and host
set -g status-right "#[fg=${thm_blue},bg=${thm_bg},bold] #(hostname -I | cut -d' ' -f1) "
set -ga status-right "#[fg=${thm_bg},bg=${thm_cyan}] #H "

# --- Keybindings ---
# Use C-a as prefix
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Prefix + r - Reload Tmux Configuration
# See: tmux-reload.sh
bind-key -N "Reload Tmux Configuration" r run-shell -b "~/.config/tmux/scripts/dv/tmux-reload.sh"

# Cheatsheet
# Prefix + ? - View Keybindings
bind-key -N "View Keybindings" ? run-shell "tmux list-keys -Na \
  | awk '{ \
      key=substr(\$0,1,12); \
      cmd=substr(\$0,13); \
      printf \"%s\\033[38;2;30;32;48m@@@%s\\033[0m\\n\", key, cmd \
    }' \
  | fzf --tmux 90%,80% \
    --color hl:-1,hl+:-1 \
    --no-hscroll --ansi \
    --layout=reverse \
    --border=rounded --border-label=' TMUX KEY BINDINGS ' \
    --preview='echo {} \
      | sed -E \"s/^[[:space:]]*(.*)[[:space:]]*@@@(.*)/\\1:\\n  \\2/\" \
      | sed -E \"s/[[:space:]]+:/:/\"' \
    --preview-window='right:70%:wrap:border-left' \
    --color=bg+:#2d3f76 --color=bg:#1e2030 \
    --color=border:#f9e2af \
    --border-label-pos='3' \
    --color=label:#f9e2af:reverse \
    --color=fg:#c8d3f5 \
    --color=gutter:#1e2030 \
    --color=header:#ff966c \
    --color=info:#545c7e \
    --color=marker:#ff007c \
    --color=pointer:#ff007c \
    --color=prompt:#65bcff \
    --color=query:#c8d3f5:regular \
    --color=scrollbar:#589ed7 \
    --color=separator:#ff966c \
    --color=spinner:#ff007c \
    > /dev/null 2>&1 || true"

bind / display-popup \
  -w 70% -h 70% \
  -T "#[bg=#{thm_yellow},fg=#{thm_bg}] Cheatsheet (Prefix: C-a) " \
  "C=\$(printf '\\033[1;34m'); \
  R=\$(printf '\\033[0m'); \
    printf \"NAVIGATION - Direct\n\
  \${C}C-h/j/k/l\${R}    Move between panes (vim-aware)\n\
NAVIGATION - with Prefix\n\
  \${C}C-p / C-n\${R}    Previous / Next Window\n\
\n\
WINDOWS & PANES\n\
  \${C}- / =\${R}        New Split Vertical / Horizontal\n\
  \${C}b\${R}            Send Pane to [Current Session] +:New Window \n\
  \${C}j\${R}            Join a Pane to [Current Session]\n\
  \${C}k\${R}            Send a Pane to [Session] window\n\
  \${C}S-Left/Right\${R} Swap window position\n\
  \${C}z\${R}            Zoom pane\n\
\n\
LAYOUT & SYNC\n\
  \${C}C-s\${R}          Toggle Sync Panes\n\
  \${C}M-h\${R}          Even Horizontal Layout\n\
  \${C}M-v\${R}          Even Vertical Layout\n\
  \${C}M-t\${R}          Tiled Layout\n\
\n\
COPY MODE\n\
  \${C}v\${R}            Enter Copy Mode\n\
  \${C}v\${R}            Start Selection\n\
  \${C}C-v\${R}          Toggle Rectangle\n\
  \${C}y\${R}            Yank (Copy)\n\
\n\
MISC\n\
  \${C}\\\`\${R}            Popup Scratchpad\n\
  \${C}r\${R}            Reload Config\n\
  \${C}?\${R}            View all (default) bindings\n\
  \${C}/\${R}            View this Cheatsheet\n\" | less -R"

# Window/Pane Creation
unbind %
unbind '"'
bind c new-window -c "#{pane_current_path}"
bind -r = split-window -h -c "#{pane_current_path}"
bind -r - split-window -v -c "#{pane_current_path}"

# Window/Pane Movement
bind b break-pane
bind -N "Join Pane" j run-shell -b "~/.config/tmux/scripts/dv/tmux-join.sh"
bind -N "Send Pane" k run-shell -b "~/.config/tmux/scripts/dv/tmux-send.sh"
bind -r S-Left swap-window -t -1 \; previous-window
bind -r S-Right swap-window -t +1 \; next-window

# Sync Panes
bind C-s setw synchronize-panes

# Pane Layout
bind M-h select-layout even-horizontal
bind M-v select-layout even-vertical
bind M-t select-layout tiled

# Scratchpad Popup
bind ` if-shell -b '[ -n "$(tmux list-clients -t scratch 2>/dev/null)" ]' \
  "detach-client -s scratch" \
  "display-popup -E -w 100% -h 50% -d \"#{pane_current_path}\" \
  -T \"#[bg=${thm_yellow},fg=${thm_bg}] ${icon_scratch} Scratch ── (Toggle: C-a \`, Join: C-a j) \" \
  \"tmux new-session -A -s scratch\""

# Pane Resizing (vim-style)
bind -r H resize-pane -L 1
bind -r J resize-pane -D 1
bind -r K resize-pane -U 1
bind -r L resize-pane -R 1

# Smart Pane Switching (Vim-aware)
# Check if current pane is running Vim
set -g @is_vim "ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\\\S+\\\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"

bind -n C-h if-shell "#{@is_vim}" "send-keys C-h" "select-pane -L"
bind -n C-j if-shell "#{@is_vim}" "send-keys C-j" "select-pane -D"
bind -n C-k if-shell "#{@is_vim}" "send-keys C-k" "select-pane -U"
bind -n C-l if-shell "#{@is_vim}" "send-keys C-l" "select-pane -R"

# Restore Clear Screen (C-l)
bind C-l send-keys 'C-l'

# Window Navigation
bind C-p previous-window
bind C-n next-window

# Copy Mode (vim-style)
bind v copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# --- Plugins & Configuration ---
# Use XDG-compliant path for plugins
set-environment -g TMUX_PLUGIN_MANAGER_PATH "~/.config/tmux/plugins"

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'sainnhe/tmux-fzf'

# Tmux FZF Options
set-environment -g TMUX_FZF_LAUNCH_KEY "C-f"
set-environment -g TMUX_FZF_OPTIONS "-p -w 80% -h 70% -m \
  --layout=reverse \
  --color=bg+:#2d3f76 \
  --color=bg:#1e2030 \
  --color=border:#589ed7 \
  --color=fg:#c8d3f5 \
  --color=gutter:#1e2030 \
  --color=header:#ff966c \
  --color=hl+:#65bcff \
  --color=hl:#65bcff \
  --color=info:#545c7e \
  --color=label:#545c7e \
  --color=marker:#ff007c \
  --color=pointer:#ff007c \
  --color=prompt:#65bcff \
  --color=query:#c8d3f5:regular \
  --color=scrollbar:#589ed7 \
  --color=separator:#ff966c \
  --color=spinner:#ff007c \
"


# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
